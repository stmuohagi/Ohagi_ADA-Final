---
title: "Final Project"
author: "Stephanie Ohagi"
date: "12/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Packages Used

```{r}
library(tidyverse) # data import
library(arsenal) # descriptives table
library(pastecs) # descriptives
library(formattable) # formatting tables
library(reshape) # melt function for histogram matrix
pacman::p_load(tidyverse, ROCR, odds.n.ends, blorr, lmtest, car) # vif is in blorr
```


Import Breast Cancer Wisconsin Data Set and Data Cleaning

```{r}

BCW <- read.csv("/Users/stephanieohagi/Downloads/data.csv", header=TRUE, sep=",", na.strings=FALSE) # reads BCW data file into R
BCW <- subset(BCW, select = -1) # remove the ID column
BCW <- subset(BCW, select = -c(12:32)) # remove SE, worst, and best columns
BCW <- BCW %>%
  mutate(diagnosis_bin = case_when(diagnosis %in% c("M") ~ 1,
                                     diagnosis %in% c("B") ~ 0)) # recode diagnosis to binary

class(BCW$diagnosis_bin) # diagnosis_bin is numeric
table(BCW$diagnosis, BCW$diagnosis_bin) # recoding was successful 

missing(BCW) # no missing values; no need for case analysis

```


Descriptives 

```{r}
descrip_gen <- stat.desc(BCW[, c(2:11)]) # general descriptives
formattable(descrip_gen)

# Differences in IVs between diagnosis groups
table_descrip <- tableby(diagnosis_bin ~., data = BCW) # creates table based on diagnosis group
descrip_sum_diag <- summary(table_descrip, title = "Descriptive Table") # summary of all other IVs

# pie chart for diagnosis
diagnosis_freq <- table(BCW$diagnosis) # freq table
color_diagnosis <- terrain.colors(2)
diagnosis_prop <- prop.table(diagnosis_freq)*100
diagnosis_prop_df <- as.data.frame(diagnosis_prop)
pielabels_diagnosis <- sprintf("%s - %3.1f%s", diagnosis_prop_df[,1], diagnosis_prop, "%")

pie(diagnosis_prop,
  labels=pielabels_diagnosis,  
  clockwise=TRUE,
  col=color_diagnosis,
  border="gray",
  radius=0.8,
  cex=0.8, 
  main="Proportions of Cancer Diagnosis")
legend(1, .4, legend=diagnosis_prop_df[,1], cex = 0.7, fill = color_diagnosis)

# histograms of all IVs between diagnosis groups
dataframe_hist <- BCW[ ,c("diagnosis", "radius_mean", "texture_mean","perimeter_mean", "area_mean", "smoothness_mean", "compactness_mean", "concavity_mean", "concave.points_mean", "symmetry_mean", "fractal_dimension_mean")]

ggplot(data = melt(dataframe_hist, id.var = "diagnosis"), mapping = aes(x = value)) + 
    geom_histogram(bins = 15, aes(fill = diagnosis), alpha=0.5) + facet_wrap(~ variable, scales = 'free_x')

```


Assumptions testing: Logistic regression
```{r}
# LINEARITY

## radius_mean: passes
BCW <- BCW %>%
  mutate(rad.times.lograd = radius_mean * log(radius_mean)) #term for linearity testing

boxTidwell_radius <- glm(diagnosis_bin ~ radius_mean + rad.times.lograd, data = BCW, family="binomial")
summary(boxTidwell_radius) # p = 0.348

## texture_mean: FAILS
BCW <- BCW %>%
  mutate(text.times.logtext = texture_mean * log(texture_mean)) 

boxTidwell_texture <- glm(diagnosis_bin ~ texture_mean + text.times.logtext, data = BCW, family="binomial")
summary(boxTidwell_texture) # p< 0.05

## perimeter_mean: passes
BCW <- BCW %>%
  mutate(peri.times.logperi = perimeter_mean * log(perimeter_mean)) 

boxTidwell_peri <- glm(diagnosis_bin ~ perimeter_mean + peri.times.logperi, data = BCW, family="binomial")
summary(boxTidwell_peri) # p = 0.652

## area_mean: passes
BCW <- BCW %>%
  mutate(area.times.logarea = area_mean * log(area_mean))

boxTidwell_area <- glm(diagnosis_bin ~ area_mean + area.times.logarea, data = BCW, family="binomial")
summary(boxTidwell_area) # p = 0.8986

## smoothness_mean: FAILS
BCW <- BCW %>%
  mutate(smooth.times.logsmooth = smoothness_mean * log(smoothness_mean)) 

boxTidwell_smooth <- glm(diagnosis_bin ~ radius_mean + smooth.times.logsmooth, data = BCW, family="binomial")
summary(boxTidwell_smooth)

## compactness_mean: FAILS
BCW <- BCW %>%
  mutate(compact.times.logcompact = compactness_mean * log(compactness_mean))

boxTidwell_compact <- glm(diagnosis_bin ~ compactness_mean + compact.times.logcompact, data = BCW, family="binomial")
summary(boxTidwell_compact) # p = 0.0062

## concavity_mean: FAILS
BCW <- BCW %>%
  mutate(concav.times.logconcav = concavity_mean * log(concavity_mean)) 

boxTidwell_concav <- glm(diagnosis_bin ~ concavity_mean + concav.times.logconcav, data = BCW, family="binomial")
summary(boxTidwell_concav) # p < 0.05

## concave.points_mean: passes
BCW <- BCW %>%
  mutate(cp.times.logcp = concave.points_mean * log(concave.points_mean))

boxTidwell_cp <- glm(diagnosis_bin ~ concave.points_mean + cp.times.logcp, data = BCW, family="binomial")
summary(boxTidwell_cp) # p = 0.647154

## symmetry_mean: FAILS
BCW <- BCW %>%
  mutate(sym.times.logsym = symmetry_mean * log(symmetry_mean)) 

boxTidwell_sym <- glm(diagnosis_bin ~ symmetry_mean + sym.times.logsym, data = BCW, family="binomial")
summary(boxTidwell_sym) # p = 0.04640

## fractal_dimension_mean: passes
BCW <- BCW %>%
  mutate(fd.times.logfd = fractal_dimension_mean * log(fractal_dimension_mean)) 

boxTidwell_fd <- glm(diagnosis_bin ~ fractal_dimension_mean + fd.times.logfd, data = BCW, family="binomial")
summary(boxTidwell_fd) # p = 0.0531

# Linearity tests meant removal of texture, smoothness, compactness, symmetry, and concavity for the sake of the logistic regression model. No available means of categorization

```



 Multivariate Logistic model
```{r}

#IVs: perimeter, area, radius, concave points, and fractal dimensions
logit_diagnosis <- glm(diagnosis_bin ~ perimeter_mean + area_mean + radius_mean + concave.points_mean + fractal_dimension_mean, data = BCW, family="binomial")
summary(logit_diagnosis) # only area and concave points are significant predictors for tumor diagnosis

#calculate and print ORs and 95% CIs  
ORdiagnosis<-exp(cbind(OR = coef(logit_diagnosis), confint(logit_diagnosis)))
ORdiagnosis #print

```



Multicolinearity and Outliers (Full Model)
```{r}
# multicolinearity
vif(logit_diagnosis) # radius, area, and perimeter have incredibly large VIFs; probably should not be included in the model

# new model with multicolinear variables removed
logit_diagnosis2 <- glm(diagnosis_bin ~ concave.points_mean + fractal_dimension_mean + area_mean, data = BCW, family="binomial")
summary(logit_diagnosis2) #  concave points and area are sign. predictors

#NEW calculation of ORs and 95% CIs  
ORdiagnosis2 <-exp(cbind(OR = coef(logit_diagnosis2), confint(logit_diagnosis2)))
ORdiagnosis2 #print

# multicolinearity again
vif(logit_diagnosis2) # YAY!

```



Model Fit
```{r}

lrtest(logit_diagnosis, logit_diagnosis2) # model without perimeter and radius is a better fit

logit_diagnosis3 <- glm(diagnosis_bin ~ concave.points_mean + fractal_dimension_mean, data = BCW, family="binomial") 
# logit model without area as a predictor

lrtest(logit_diagnosis2, logit_diagnosis3) # model WITHOUT area is a better fit

#Various pseudo R squares, log likelihood, deviance, AIC, BIC
blr_model_fit_stats(logit_diagnosis3)

#Hosmer lemeshow goodness of fit test: a significant p value indicates a bad fit
blr_test_hosmer_lemeshow(logit_diagnosis3) # p = 0.765; good model fit, chi-square = 4.9290



```


Evaluate Model Performance
```{r}

table(BCW$diagnosis) # M: 212 cases

#new dataset with only benign diagnoses = 0
BCW_benign <- BCW %>%
  filter(diagnosis == 'B')

#create a new dataset where the number of malignant and benign cases are the same
BCW_malignant<- BCW %>%
  filter(diagnosis=='M') #keep only malignant cases

set.seed(1) 
BCW_malignant <- sample_n(BCW_malignant, size=212) # sample from smaller number of the two groups

BCW_balance <-BCW_malignant %>%
  rbind(BCW_benign) #Combine malignant with benign

multi_logit_diagnosis <- glm(diagnosis_bin ~ concave.points_mean + fractal_dimension_mean, data = BCW_balance, family = "binomial")
summary(multi_logit_diagnosis)



#b.
pred_diag <- predict(multi_logit_diagnosis, newdata = BCW_balance, type = 'response')
hist(pred_diag) # histogram of predicted probabilities for diagnosis status

# creating a dataframe of predicted VALUES for diagnosis (number of patients)
df1 <-as.data.frame(pred_diag)
df2 <-cbind(df1, BCW_balance$diagnosis)

# plot distribution for predicted values
ggplot(data=df2) +
  geom_density(aes(x=pred_diag, color=BCW_balance$diagnosis, linetype=BCW_balance$diagnosis))

odds.n.ends(multi_logit_diagnosis)
# sensitivity: 0.8820755
# Specificity:0.9467787


# d.
ROCR_diagnosis = prediction(as.numeric(pred_diag), as.numeric(BCW_balance$diagnosis_bin)) # predicted probability values for outcome variables


perf_diag = performance(ROCR_diagnosis,"tpr", "fpr") #tpr on y axis and fpr on x axis

# ROC curve
plot(perf_diag, colorsize=T, color="dark green", print.cutoffs.at=seq(0,1,0.1))
abline(a = 0, b = 1)

# AUC
auc_diag = performance(ROCR_diagnosis, measure = "auc")
auc_diag@y.values # AUC is 0.9751467


```


 AUC of 0.975 means that there is a 97.5% probability of a randomly-chosen  wearing a seatbelt case ranking higher than a randomly-chosen 'negative'Not always' wearing a seatbelt case. This model is moderately good at distinguishing between those who reported always wearing their seatbelts versus those who did not. The sensitivity of this model indicates that it has a 58.4% chance of identifying an individual who always wears their seatbelt within the 'Always' group. The specificity of 63.4% indicates that this model has a 63.4% chance of identifying an individual who does not always wear their seatbelt within the 'Not always' group. The odds ratio for BMI means that for every one unit increase in BMI, the odds of the individual always wearing a seatbelt decreases by 0.965 times, or 3.5%, when adjusted for sex and age.





